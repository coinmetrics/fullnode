stages:
  - build

images:
  image:
    name: registry.gitlab.com/coinmetrics/infrastructure/nix:2.10.1
    entrypoint: [""]
  stage: build
  before_script:
    - /before-script.sh
  script:
    - $(nix-build --no-out-link -QA updateAllScript --argstr imageBaseName "$DOCKER_REPO" ./release.nix)
  after_script:
    - /after-script.sh
    - mkdir -p artifacts
    - cp -r /nix/var/log/nix/drvs artifacts
  artifacts:
    expire_in: "1 week"
    when: always
    paths:
      - artifacts
  tags:
    - kube-any-large
  only:
    - master
    - schedules

images-mr:
  image:
    name: registry.gitlab.com/coinmetrics/infrastructure/nix:2.10.1
    entrypoint: [""]
  stage: build
  before_script:
    - /before-script.sh
  script:
    - nix-build --no-out-link -QA updateAllScript --argstr imageBaseName "$DOCKER_REPO" ./release.nix
  after_script:
    - /after-script.sh
    - mkdir -p artifacts
    - cp -r /nix/var/log/nix/drvs artifacts
  artifacts:
    expire_in: "1 week"
    when: always
    paths:
      - artifacts
  tags:
    - kube-any-large
  only:
    - merge_requests
